# Task 1.6 Visual Overview - Replication Lag Monitoring

## Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Takhin Broker Cluster                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚  â”‚ Leader   â”‚â”€â”€â”€â”€â”€â”€â–¶â”‚Follower 2â”‚       â”‚Follower 3â”‚                â”‚
â”‚  â”‚ (Broker1)â”‚â—€â”€â”€â”€â”€â”€â”€â”‚(Broker 2)â”‚       â”‚(Broker 3)â”‚                â”‚
â”‚  â”‚  LEO:100 â”‚       â”‚  LEO: 95 â”‚       â”‚  LEO: 90 â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚
â”‚       â”‚                  â”‚                    â”‚                      â”‚
â”‚       â”‚   Fetch Reqs     â”‚   Fetch Reqs      â”‚                      â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                          â”‚                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚    Metrics Collector (30s)         â”‚
          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
          â”‚  â”‚ collectReplicationMetrics()  â”‚  â”‚
          â”‚  â”‚  â€¢ Track LEO per follower    â”‚  â”‚
          â”‚  â”‚  â€¢ Calculate offset lag      â”‚  â”‚
          â”‚  â”‚  â€¢ Calculate time lag        â”‚  â”‚
          â”‚  â”‚  â€¢ Detect ISR changes        â”‚  â”‚
          â”‚  â”‚  â€¢ Update Prometheus metrics â”‚  â”‚
          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚      Prometheus Metrics            â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚ takhin_replication_lag_offsets     â”‚
          â”‚   topic="events" partition="0"     â”‚
          â”‚   follower_id="2" value=5          â”‚
          â”‚   follower_id="3" value=10         â”‚
          â”‚                                    â”‚
          â”‚ takhin_replication_lag_time_ms     â”‚
          â”‚   follower_id="2" value=1500       â”‚
          â”‚   follower_id="3" value=2000       â”‚
          â”‚                                    â”‚
          â”‚ takhin_replication_isr_size        â”‚
          â”‚   topic="events" partition="0"     â”‚
          â”‚   value=3                          â”‚
          â”‚                                    â”‚
          â”‚ takhin_replication_under_replicatedâ”‚
          â”‚   value=0  (healthy)               â”‚
          â”‚                                    â”‚
          â”‚ takhin_replication_isr_shrinks_totalâ”‚
          â”‚   value=0                          â”‚
          â”‚                                    â”‚
          â”‚ takhin_replication_isr_expands_totalâ”‚
          â”‚   value=2                          â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚      Prometheus Server             â”‚
          â”‚         (Scrape :9090)             â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚          â”‚          â”‚
                â–¼          â–¼          â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Grafana â”‚ â”‚ Alerts  â”‚ â”‚ Queries â”‚
         â”‚Dashboardâ”‚ â”‚ Manager â”‚ â”‚ API     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Metric Flow Diagram

```
Topic Updates
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic.UpdateFollowerLEO()           â”‚
â”‚  â€¢ Store follower LEO                â”‚
â”‚  â€¢ Record last fetch time            â”‚
â”‚  â€¢ Trigger UpdateISR()               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Topic.UpdateISR()                   â”‚
â”‚  â€¢ Calculate new ISR                 â”‚
â”‚  â€¢ Compare with old ISR              â”‚
â”‚  â€¢ Detect shrink/expand              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Collector.collectReplicationMetrics()â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 1. Get replicas & ISR          â”‚  â”‚
â”‚  â”‚ 2. Detect ISR changes          â”‚  â”‚
â”‚  â”‚ 3. Calculate offset lag        â”‚  â”‚
â”‚  â”‚ 4. Calculate time lag          â”‚  â”‚
â”‚  â”‚ 5. Update metrics              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                 â–¼                  â–¼                  â–¼
UpdateReplicationMetrics() RecordISRShrink() RecordISRExpand() UpdateLagTime()
         â”‚                 â”‚                  â”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                         Prometheus Metrics
```

## ISR Change Detection Flow

```
Collection Cycle N-1:
  ISR = [1, 2, 3]  (3 replicas)
  Store in lastISRSizes["topic-0"] = 3

         â”‚
         â–¼
  [Follower 3 falls behind]
         â”‚
         â–¼

Collection Cycle N:
  ISR = [1, 2]  (2 replicas)
  oldISRSize = 3 (from cache)
  newISRSize = 2

         â”‚
         â–¼
  
  Detect: oldISRSize > newISRSize
  
         â”‚
         â”œâ”€â”€â”€â”€â”€â–º RecordISRShrink("topic", 0)
         â”‚       â””â”€â–º ReplicationISRShrinks.Inc()
         â”‚
         â”œâ”€â”€â”€â”€â”€â–º Logger.Warn("ISR shrunk")
         â”‚
         â””â”€â”€â”€â”€â”€â–º Store lastISRSizes["topic-0"] = 2

         â”‚
         â–¼
  
  Prometheus metrics updated:
    takhin_replication_isr_size{topic="topic",partition="0"} = 2
    takhin_replication_isr_shrinks_total{...} += 1
    takhin_replication_under_replicated{...} = 1
```

## Metrics Hierarchy

```
takhin_replication_*
â”‚
â”œâ”€ lag_offsets                    [Gauge with labels: topic, partition, follower_id]
â”‚  â””â”€ Per-follower offset lag
â”‚
â”œâ”€ lag_time_ms                    [Gauge with labels: topic, partition, follower_id]
â”‚  â””â”€ Time since last fetch
â”‚
â”œâ”€ isr_size                       [Gauge with labels: topic, partition]
â”‚  â””â”€ Current ISR count
â”‚
â”œâ”€ isr_shrinks_total              [Counter with labels: topic, partition]
â”‚  â””â”€ ISR removal events
â”‚
â”œâ”€ isr_expands_total              [Counter with labels: topic, partition]
â”‚  â””â”€ ISR addition events
â”‚
â”œâ”€ replicas_total                 [Gauge with labels: topic, partition]
â”‚  â””â”€ Target replica count
â”‚
â”œâ”€ under_replicated               [Gauge with labels: topic, partition]
â”‚  â””â”€ 1 if ISR < replicas, 0 otherwise
â”‚
â”œâ”€ fetch_requests_total           [Counter with label: follower_id]
â”‚  â””â”€ Replication fetch count
â”‚
â”œâ”€ fetch_latency_seconds          [Histogram with label: follower_id]
â”‚  â””â”€ Fetch request duration
â”‚
â”œâ”€ bytes_in_total                 [Counter with labels: topic, partition]
â”‚  â””â”€ Inbound replication traffic
â”‚
â””â”€ bytes_out_total                [Counter with labels: topic, partition]
   â””â”€ Outbound replication traffic
```

## Alert Severity Levels

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CRITICAL ALERTS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”´ Under-Replicated Partitions                             â”‚
â”‚    takhin_replication_under_replicated == 1                â”‚
â”‚    for: 5m                                                 â”‚
â”‚    â†’ Data at risk, immediate action required               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ”´ High Replication Lag                                    â”‚
â”‚    takhin_replication_lag_offsets > 10000                  â”‚
â”‚    for: 10m                                                â”‚
â”‚    â†’ Followers far behind, may affect durability           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WARNING ALERTS                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ¡ Frequent ISR Shrinks                                    â”‚
â”‚    rate(isr_shrinks_total[30m]) > 0.1                      â”‚
â”‚    â†’ Replication instability                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ¡ Stale Replication Fetch                                 â”‚
â”‚    takhin_replication_lag_time_ms > 15000                  â”‚
â”‚    â†’ Follower not fetching regularly                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ¡ High Fetch Latency                                      â”‚
â”‚    histogram_quantile(0.99, fetch_latency) > 1.0           â”‚
â”‚    â†’ Network or disk issues                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸŸ¡ No Replication Activity                                 â”‚
â”‚    rate(fetch_requests_total[5m]) == 0                     â”‚
â”‚    â†’ Follower may be down                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Grafana Dashboard Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Takhin Replication Monitoring Dashboard                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Replication Lag        â”‚  â”‚ Under-Replicated        â”‚    â”‚
â”‚  â”‚ (Offsets)              â”‚  â”‚ Partitions Count        â”‚    â”‚
â”‚  â”‚                        â”‚  â”‚                         â”‚    â”‚
â”‚  â”‚  ğŸ“ˆ Line graph         â”‚  â”‚  ğŸ”¢ Single Stat         â”‚    â”‚
â”‚  â”‚  Max lag per topic     â”‚  â”‚  Current count          â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ISR Size vs Target     â”‚  â”‚ ISR Changes Rate        â”‚    â”‚
â”‚  â”‚                        â”‚  â”‚                         â”‚    â”‚
â”‚  â”‚  ğŸ“Š Bar chart          â”‚  â”‚  ğŸ“ˆ Line graph          â”‚    â”‚
â”‚  â”‚  ISR / Replicas        â”‚  â”‚  Shrinks + Expands      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Replication Lag Time   â”‚  â”‚ Replication Throughput  â”‚    â”‚
â”‚  â”‚                        â”‚  â”‚                         â”‚    â”‚
â”‚  â”‚  ğŸ“ˆ Heatmap            â”‚  â”‚  ğŸ“ˆ Stacked area        â”‚    â”‚
â”‚  â”‚  Lag time per follower â”‚  â”‚  MB/s per topic         â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Fetch Latency P99 (Histogram)                        â”‚   â”‚
â”‚  â”‚  ğŸ“Š Per-follower replication fetch latency           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Test Coverage Map

```
replication_lag_test.go
â”‚
â”œâ”€ TestReplicationLagMetrics          âœ… 3 test cases
â”‚  â”œâ”€ zero_lag
â”‚  â”œâ”€ small_lag
â”‚  â””â”€ large_lag
â”‚
â”œâ”€ TestReplicationLagTimeMetrics      âœ… 2 test cases
â”‚  â”œâ”€ recent_fetch
â”‚  â””â”€ stale_fetch
â”‚
â”œâ”€ TestISRMetrics                     âœ… 3 test cases
â”‚  â”œâ”€ fully_replicated
â”‚  â”œâ”€ under_replicated
â”‚  â””â”€ single_replica
â”‚
â”œâ”€ TestISRChangeMetrics               âœ… 1 test case
â”‚  â””â”€ shrink and expand counters
â”‚
â”œâ”€ TestReplicationBytesMetrics        âœ… 1 test case
â”‚  â””â”€ bytes in/out tracking
â”‚
â”œâ”€ TestCollectorReplicationMetrics    âœ… 1 test case
â”‚  â””â”€ end-to-end collection
â”‚
â”œâ”€ TestCollectorISRChangeDetection    âœ… 1 test case
â”‚  â””â”€ ISR change logging
â”‚
â””â”€ TestReplicationFetchMetrics        âœ… 1 test case
   â””â”€ fetch request tracking

Total: 13 test cases, all passing âœ…
```

## Component Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Produce Path                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Producer â”€â”€â–º Leader â”€â”€â–º Log.Append()
                 â”‚           â”‚
                 â”‚           â””â”€â”€â–º Update LEO
                 â”‚
                 â””â”€â”€â–º Followers fetch
                         â”‚
                         â”œâ”€â”€â–º UpdateFollowerLEO(followerID, leo)
                         â”‚      â”‚
                         â”‚      â””â”€â”€â–º Store LEO + timestamp
                         â”‚
                         â””â”€â”€â–º UpdateISR()
                                â”‚
                                â””â”€â”€â–º Recalculate ISR
                                     â””â”€â”€â–º Detect changes

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Metrics Collection Path                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Collector (timer) â”€â”€â–º collectStorageMetrics()
                           â”‚
                           â””â”€â”€â–º For each partition:
                                  â”‚
                                  â”œâ”€â”€â–º Get leader LEO
                                  â”œâ”€â”€â–º Get replicas & ISR
                                  â”œâ”€â”€â–º Get follower LEOs
                                  â”œâ”€â”€â–º Calculate lags
                                  â”œâ”€â”€â–º Detect ISR changes
                                  â””â”€â”€â–º Update Prometheus

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Query/Alert Path                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  Prometheus â”€â”€â–º Scrape /metrics endpoint (15s)
      â”‚
      â”œâ”€â”€â–º Store time-series data
      â”‚
      â””â”€â”€â–º Evaluate alert rules
             â”‚
             â”œâ”€â”€â–º UnderReplicatedPartitions
             â”œâ”€â”€â–º HighReplicationLag
             â”œâ”€â”€â–º FrequentISRShrinks
             â””â”€â”€â–º StaleReplicationFetch
                    â”‚
                    â””â”€â”€â–º Alert Manager â”€â”€â–º Notifications
```

## Status: âœ… Complete

All components implemented, tested, and documented.
