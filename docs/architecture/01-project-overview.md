# 项目整体架构设计

## 1. 项目概述

### 1.1 项目目标
基于 Redpanda 和 Redpanda Console 的开源项目，使用 Go 和 React 技术栈完全重写和复刻，构建一个高性能、可扩展的分布式流数据平台及其管理控制台。

### 1.2 核心组件
本项目包含两大核心组件：

1. **Takhin Core (复刻 Redpanda)**
   - 兼容 Apache Kafka® 协议的流数据平台
   - 高性能消息队列
   - 分布式存储系统
   - 无需 ZooKeeper 依赖

2. **Takhin Console (复刻 Redpanda Console)**
   - Web 管理界面
   - 消息查看器
   - 集群监控
   - Schema Registry 管理
   - Kafka Connect 管理

### 1.3 技术栈选型

#### 后端技术栈
- **语言**: Go 1.25+
- **Web 框架**: Chi Router (轻量级、高性能)
- **RPC 框架**: Connect (gRPC/HTTP 双协议支持)
- **数据序列化**: Protocol Buffers
- **配置管理**: Koanf
- **日志**: slog (Go 标准库)
- **监控**: Prometheus
- **测试**: testify + testcontainers

#### 前端技术栈
- **框架**: React 18+
- **语言**: TypeScript 5+
- **构建工具**: Rsbuild (基于 Rspack)
- **UI 框架**: Chakra UI
- **状态管理**: React Query + Context
- **路由**: React Router v6
- **表单**: React Hook Form + Zod
- **测试**: Vitest + Playwright
- **代码质量**: Biome (统一的 linter 和 formatter)

## 2. 系统架构分层

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     Takhin Platform                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────────────┐         ┌──────────────────┐          │
│  │  Takhin Console  │────────▶│   Takhin Core    │          │
│  │  (Web UI)        │         │   (Streaming)    │          │
│  │                  │         │                  │          │
│  │  - 前端 (React)   │         │  - Kafka API     │          │
│  │  - 后端 (Go API)  │         │  - Admin API     │          │
│  └──────────────────┘         │  - HTTP Proxy    │          │
│           │                   │  - Schema Reg    │          │
│           │                   └──────────────────┘          │
│           │                            │                     │
│           │                            │                     │
│           └────────────────────────────┘                     │
│                     监控和管理                                │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 部署架构

```
┌─────────────────────────────────────────────────────────────┐
│                      客户端层                                 │
├─────────────────────────────────────────────────────────────┤
│  Web Browser  │  CLI (rpk)  │  Kafka Clients  │  其他应用    │
└────────┬────────────┬─────────────────┬──────────────┬──────┘
         │            │                 │              │
         │            └─────────┐       │              │
         │                      │       │              │
┌────────▼──────────────────────▼───────▼──────────────▼──────┐
│                      负载均衡层                                │
├─────────────────────────────────────────────────────────────┤
│   Nginx / HAProxy / Cloud Load Balancer                      │
└────────┬─────────────────────────────────────┬──────────────┘
         │                                     │
         │                                     │
┌────────▼─────────────────┐      ┌───────────▼──────────────┐
│   Takhin Console         │      │   Takhin Core            │
├──────────────────────────┤      ├──────────────────────────┤
│                          │      │                          │
│ ┌──────────────────────┐ │      │ ┌──────────────────────┐ │
│ │   Frontend (React)   │ │      │ │   Kafka API Server   │ │
│ │   - Static Assets    │ │      │ │   - Port: 9092       │ │
│ └──────────────────────┘ │      │ └──────────────────────┘ │
│                          │      │                          │
│ ┌──────────────────────┐ │      │ ┌──────────────────────┐ │
│ │   Backend (Go)       │ │      │ │   Admin API Server   │ │
│ │   - REST/gRPC API    │ │──────▶│   - Port: 9644       │ │
│ │   - Port: 8080       │ │      │ └──────────────────────┘ │
│ └──────────────────────┘ │      │                          │
│                          │      │ ┌──────────────────────┐ │
└──────────────────────────┘      │ │   HTTP Proxy         │ │
                                  │ │   - Port: 8082       │ │
                                  │ └──────────────────────┘ │
                                  │                          │
                                  │ ┌──────────────────────┐ │
                                  │ │   Schema Registry    │ │
                                  │ │   - Port: 8081       │ │
                                  │ └──────────────────────┘ │
                                  │                          │
                                  │ ┌──────────────────────┐ │
                                  │ │   Storage Engine     │ │
                                  │ │   - Raft Consensus   │ │
                                  │ │   - Log Segments     │ │
                                  │ └──────────────────────┘ │
                                  └──────────────────────────┘
                                             │
                                             │
                                  ┌──────────▼──────────────┐
                                  │   Persistent Storage    │
                                  ├─────────────────────────┤
                                  │ - Local Disk (SSD)      │
                                  │ - S3 (Tiered Storage)   │
                                  └─────────────────────────┘
```

## 3. 数据流架构

### 3.1 消息生产和消费流程

```
Producer Client
     │
     │ 1. 发送消息
     ▼
┌─────────────────┐
│  Kafka API      │
│  Handler        │
└────────┬────────┘
         │
         │ 2. 验证和路由
         ▼
┌─────────────────┐
│  Partition      │
│  Leader         │
└────────┬────────┘
         │
         │ 3. 写入日志
         ▼
┌─────────────────┐
│  Log Segment    │
│  Storage        │
└────────┬────────┘
         │
         │ 4. 复制到 Follower
         ▼
┌─────────────────┐
│  Partition      │
│  Followers      │
└─────────────────┘
         │
         │ 5. 返回 ACK
         ▼
Producer Client


Consumer Client
     │
     │ 1. 请求消息
     ▼
┌─────────────────┐
│  Kafka API      │
│  Handler        │
└────────┬────────┘
         │
         │ 2. 定位 Offset
         ▼
┌─────────────────┐
│  Partition      │
│  Leader/Follower│
└────────┬────────┘
         │
         │ 3. 读取日志
         ▼
┌─────────────────┐
│  Log Segment    │
│  Storage        │
└────────┬────────┘
         │
         │ 4. 返回消息批次
         ▼
Consumer Client
```

### 3.2 Console 数据流

```
Browser (React)
     │
     │ HTTP/WebSocket
     ▼
┌─────────────────┐
│  Console        │
│  Backend (Go)   │
└────────┬────────┘
         │
         │ Admin API
         ▼
┌─────────────────┐      ┌──────────────┐
│  Takhin Core    │◀─────│ Schema Reg   │
│  Admin API      │      └──────────────┘
└────────┬────────┘
         │
         │ Kafka API
         ▼
┌─────────────────┐
│  Metadata       │
│  Topics         │
│  Consumer Groups│
│  ACLs           │
└─────────────────┘
```

## 4. 核心设计原则

### 4.1 高性能
- **零拷贝 I/O**: 使用 sendfile 系统调用
- **批量处理**: 消息批量读写
- **异步非阻塞**: Go 协程实现高并发
- **内存池管理**: 减少 GC 压力
- **缓存策略**: 多级缓存机制

### 4.2 高可用
- **Raft 共识算法**: 保证数据一致性
- **多副本复制**: 数据冗余存储
- **自动故障转移**: Leader 选举机制
- **健康检查**: 定期探测节点状态
- **优雅降级**: 部分功能失败不影响核心服务

### 4.3 可扩展
- **水平扩展**: 增加节点提升性能
- **分区机制**: 数据分片存储
- **插件架构**: 支持功能扩展
- **API 版本控制**: 向后兼容
- **配置热更新**: 无需重启服务

### 4.4 易运维
- **统一配置**: 声明式配置文件
- **完善监控**: Prometheus 指标导出
- **日志聚合**: 结构化日志
- **问题诊断**: Debug Bundle
- **自动化部署**: Docker/Kubernetes 支持

### 4.5 安全性
- **身份认证**: SASL/SCRAM, mTLS, OAuth2
- **权限控制**: ACL 细粒度授权
- **传输加密**: TLS 1.3
- **审计日志**: 操作审计追踪
- **敏感数据**: 配置加密存储

## 5. 技术决策

### 5.1 为什么选择 Go
1. **高性能**: 接近 C/C++ 的性能，优于 Java
2. **并发模型**: Goroutine 轻量级协程，适合高并发场景
3. **内存管理**: 自动 GC，但可控性强
4. **编译型语言**: 单一二进制部署，无运行时依赖
5. **生态系统**: 丰富的网络和并发库
6. **可维护性**: 简洁语法，易于团队协作

### 5.2 为什么选择 React
1. **生态成熟**: 大量优质组件库
2. **性能优秀**: Virtual DOM 和 Fiber 架构
3. **开发体验**: Hook 简化状态管理
4. **类型安全**: TypeScript 集成完善
5. **社区活跃**: 问题解决方案丰富
6. **企业级**: 被大量企业级项目验证

### 5.3 为什么选择 Protocol Buffers
1. **高效编码**: 二进制格式，体积小
2. **强类型**: 编译期类型检查
3. **跨语言**: 支持多种编程语言
4. **向后兼容**: 字段可选，版本演进友好
5. **代码生成**: 自动生成序列化代码
6. **文档化**: proto 文件即 API 文档

## 6. 非功能性需求

### 6.1 性能指标
- **吞吐量**: 单节点 >100K msg/s (1KB 消息)
- **延迟**: P99 <10ms (本地网络)
- **并发**: 支持 10K+ 连接
- **CPU 使用**: <80% (正常负载)
- **内存使用**: <8GB (单节点)

### 6.2 可用性指标
- **服务可用性**: 99.9%
- **数据持久性**: 99.999%
- **恢复时间**: <5 分钟 (单节点故障)
- **故障检测**: <30 秒

### 6.3 可扩展性指标
- **最大节点数**: 100+
- **最大主题数**: 10,000+
- **最大分区数**: 100,000+
- **数据保留**: 无限制 (取决于存储)

### 6.4 安全性要求
- **加密**: TLS 1.3
- **认证**: 支持多种认证方式
- **授权**: 基于 ACL 的访问控制
- **审计**: 完整的操作日志
- **合规**: 满足 SOC2, GDPR 等标准

## 7. 项目组织结构

```
takhin/
├── README.md
├── LICENSE
├── Makefile
├── Taskfile.yaml
├── .github/
│   ├── workflows/           # CI/CD 配置
│   └── copilot-instructions.md
├── docs/                    # 文档目录
│   ├── architecture/        # 架构设计
│   ├── api/                 # API 文档
│   ├── development/         # 开发指南
│   ├── deployment/          # 部署文档
│   └── testing/             # 测试文档
├── projects/
│   ├── core/                # Takhin Core (复刻 Redpanda)
│   │   ├── cmd/             # 主程序入口
│   │   ├── pkg/             # 公共包
│   │   ├── internal/        # 内部包
│   │   ├── api/             # API 定义
│   │   ├── proto/           # Protocol Buffers
│   │   ├── configs/         # 配置文件
│   │   └── tests/           # 测试
│   └── console/             # Takhin Console
│       ├── backend/         # Go 后端
│       │   ├── cmd/
│       │   ├── pkg/
│       │   ├── internal/
│       │   └── proto/
│       └── frontend/        # React 前端
│           ├── src/
│           ├── public/
│           └── tests/
├── tools/                   # 开发工具
├── scripts/                 # 构建和部署脚本
└── deployments/             # 部署配置
    ├── docker/
    ├── kubernetes/
    └── helm/
```

## 8. 里程碑规划

### Phase 1: 基础架构 (2-3 个月)
- [ ] 项目脚手架搭建
- [ ] 基础 Proto 定义
- [ ] 配置管理系统
- [ ] 日志和监控框架
- [ ] CI/CD 流水线

### Phase 2: 核心引擎 (4-6 个月)
- [ ] Kafka 协议实现
- [ ] Raft 共识算法
- [ ] 存储引擎
- [ ] 分区和副本管理
- [ ] 网络层实现

### Phase 3: 高级特性 (3-4 个月)
- [ ] Schema Registry
- [ ] HTTP Proxy
- [ ] Kafka Connect
- [ ] 事务支持
- [ ] 压缩和编码

### Phase 4: 管理控制台 (3-4 个月)
- [ ] Console 后端 API
- [ ] Console 前端界面
- [ ] 消息查看器
- [ ] 集群监控
- [ ] ACL 管理

### Phase 5: 优化和完善 (持续)
- [ ] 性能优化
- [ ] 测试覆盖
- [ ] 文档完善
- [ ] 生产环境验证
- [ ] 社区建设

## 9. 风险评估

### 9.1 技术风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| Kafka 协议兼容性 | 高 | 中 | 严格参考官方文档，充分测试 |
| Raft 算法实现复杂 | 高 | 中 | 使用成熟库，逐步迭代 |
| 性能不达标 | 高 | 低 | 早期性能测试，持续优化 |
| Go GC 延迟 | 中 | 低 | 优化内存分配，调优 GC 参数 |

### 9.2 项目风险
| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| 进度延期 | 中 | 中 | 合理规划，预留缓冲时间 |
| 团队人员变动 | 中 | 低 | 文档完善，代码规范统一 |
| 需求变更 | 低 | 高 | 敏捷开发，快速迭代 |
| 技术选型错误 | 高 | 低 | 充分调研，POC 验证 |

## 10. 成功标准

### 10.1 功能完整性
- ✅ 完整实现 Kafka Core API
- ✅ 支持主流 Kafka 客户端
- ✅ 管理界面功能齐全
- ✅ Schema Registry 完整支持

### 10.2 性能达标
- ✅ 吞吐量达到预期指标
- ✅ 延迟控制在可接受范围
- ✅ 资源使用合理

### 10.3 质量保证
- ✅ 测试覆盖率 ≥ 80%
- ✅ 无 P0/P1 级别 Bug
- ✅ 代码质量检查通过

### 10.4 可运维性
- ✅ 部署文档完善
- ✅ 监控告警完备
- ✅ 故障恢复流程清晰

---

**文档版本**: v1.0  
**最后更新**: 2025-12-14  
**维护者**: Takhin Team
