# Takhin Configuration File
# All settings can be overridden using environment variables with TAKHIN_ prefix
# Example: TAKHIN_SERVER_PORT=9093

# Server Configuration
server:
  host: "0.0.0.0"
  port: 9092
  
  # TLS/SSL Configuration
  tls:
    enabled: false                    # Enable TLS encryption
    cert:
      file: ""                        # Path to server certificate (required if TLS enabled)
    key:
      file: ""                        # Path to server private key (required if TLS enabled)
    ca:
      file: ""                        # Path to CA certificate (for client verification)
    client:
      auth: "none"                    # Client authentication: none, request, require
    verify:
      client:
        cert: false                   # Verify client certificates (mTLS)
    min:
      version: "TLS1.2"               # Minimum TLS version: TLS1.0, TLS1.1, TLS1.2, TLS1.3
    cipher:
      suites: []                      # Custom cipher suites (empty = use defaults)
    prefer:
      server:
        cipher: false                 # Prefer server cipher suites

# Kafka Protocol Configuration
kafka:
  broker:
    id: 1
  
  # Cluster Configuration - List of all broker IDs in the cluster
  # If not specified, defaults to single-broker mode with current broker ID
  # Example for 3-broker cluster: [1, 2, 3]
  cluster:
    brokers: [1]  # Single broker by default, change for multi-broker setup
  
  listeners:
    - "tcp://0.0.0.0:9092"
  advertised:
    host: "localhost"
    port: 9092
  
  # Message and Connection Limits
  max:
    message:
      bytes: 1048576      # 1MB
    connections: 1000
  request:
    timeout:
      ms: 30000           # 30 seconds
  connection:
    timeout:
      ms: 60000           # 60 seconds

# Storage Configuration
storage:
  data:
    dir: "/tmp/takhin-data"
  
  # Log Segment Settings
  log:
    segment:
      size: 1073741824    # 1GB
    retention:
      hours: 168          # 7 days
      bytes: 0            # 0 = unlimited
    
    # Log Cleanup and Flush
    cleanup:
      interval:
        ms: 300000        # 5 minutes
    flush:
      interval:
        ms: 1000          # 1 second
      messages: 10000     # Flush after 10k messages
  
  # Background Cleaner Settings
  cleaner:
    enabled: true         # Enable background cleanup and compaction
  
  # Log Compaction Settings
  compaction:
    interval:
      ms: 600000          # 10 minutes
    min:
      cleanable:
        ratio: 0.5        # Compact when 50% is dirty
  
  # Encryption at Rest Configuration
  encryption:
    enabled: false        # Enable encryption for log segments
    algorithm: "none"     # Encryption algorithm: none, aes-128-gcm, aes-256-gcm, chacha20-poly1305
    key:
      dir: ""             # Directory for encryption keys (defaults to <data.dir>/keys)
  
  # Tiered Storage Configuration (S3 Integration)
  tiered:
    enabled: false                       # Enable tiered storage with S3
    s3:
      bucket: ""                         # S3 bucket name for cold storage
      region: "us-east-1"                # AWS region
      prefix: "takhin-segments"          # S3 key prefix
      endpoint: ""                       # Custom S3 endpoint (for MinIO/compatible)
    cold:
      age:
        hours: 168                       # Archive segments older than 7 days
    warm:
      age:
        hours: 72                        # Mark as warm after 3 days
    archive:
      interval:
        minutes: 60                      # Run archive policy every hour
    local:
      cache:
        size:
          mb: 10240                      # 10GB local cache for hot data
    auto:
      archive:
        enabled: true                    # Auto-archive cold segments

# Replication Configuration
replication:
  default:
    replication:
      factor: 1           # Default replication factor (1 = no replication)
  replica:
    lag:
      time:
        max:
          ms: 10000       # 10 seconds - max lag before removing from ISR
    fetch:
      wait:
        max:
          ms: 500         # Follower fetch wait time
      max:
        bytes: 1048576    # 1MB - max bytes per follower fetch

# Raft Consensus Configuration (Leader Election Optimization)
raft:
  # Heartbeat and Election Timeouts (optimized for fast elections)
  heartbeat:
    timeout:
      ms: 1000            # 1 second - time without leader contact before election
  election:
    timeout:
      ms: 3000            # 3 seconds - max election duration (target < 5s)
  leader:
    lease:
      timeout:
        ms: 500           # 500ms - leader lease timeout
  commit:
    timeout:
      ms: 50              # 50ms - commit timeout for log replication
  
  # Snapshot Configuration
  snapshot:
    interval:
      ms: 120000          # 2 minutes - snapshot interval
    threshold: 8192       # Number of logs before snapshot
  
  # PreVote Configuration (reduces unnecessary elections)
  prevote:
    enabled: true         # Enable PreVote to avoid election storms
  
  # Append Entries Configuration
  max:
    append:
      entries: 64         # Max entries per AppendEntries RPC

# Logging Configuration
logging:
  level: "info"     # debug, info, warn, error
  format: "json"    # json, text

# Metrics Configuration
metrics:
  enabled: true
  host: "0.0.0.0"
  port: 9090
  path: "/metrics"

# Health Check Configuration
health:
  enabled: true        # Enable health check HTTP server
  host: "0.0.0.0"     # Health check server host
  port: 9091          # Health check server port (separate from Kafka)

# ACL Configuration
acl:
  enabled: false      # Enable ACL authorization (disabled by default)

# SASL Authentication Configuration
sasl:
  enabled: false      # Enable SASL authentication (disabled by default)
  mechanisms:         # Supported SASL mechanisms
    - PLAIN
    - SCRAM-SHA-256
    - SCRAM-SHA-512
  plain:
    users: ""         # Path to plain users file (optional)
  cache:
    enabled: true     # Enable authentication cache
    ttl:
      seconds: 3600   # Cache TTL: 1 hour
    max:
      entries: 1000   # Max cached sessions
    cleanup:
      ms: 60000       # Cleanup interval: 1 minute
  gssapi:
    service:
      name: "kafka"   # GSSAPI service name
    keytab:
      path: ""        # Path to keytab file
    realm: ""         # Kerberos realm
    validate:
      kdc: true       # Validate against KDC

# Throttle Configuration (Network Rate Limiting)
throttle:
  # Producer throttling
  producer:
    bytes:
      per:
        second: 10485760    # 10 MB/s (0 = disabled)
    burst: 20971520         # 20 MB burst capacity
  
  # Consumer throttling
  consumer:
    bytes:
      per:
        second: 10485760    # 10 MB/s (0 = disabled)
    burst: 20971520         # 20 MB burst capacity
  
  # Dynamic rate adjustment
  dynamic:
    enabled: false          # Enable dynamic throttle adjustment
    check:
      interval:
        ms: 5000            # Check interval for rate adjustment
    min:
      rate: 1048576         # Minimum rate: 1 MB/s
    max:
      rate: 104857600       # Maximum rate: 100 MB/s
    target:
      util:
        pct: 0.80           # Target utilization: 80%
    adjustment:
      step: 0.10            # Adjustment step: 10%


# Audit Log Configuration
audit:
  enabled: false                # Enable audit logging
  output:
    path: ""                    # Path to audit log file (default: <data-dir>/audit/audit.log)
  max:
    file:
      size: 104857600           # 100MB max file size before rotation
    backups: 10                 # Max number of backup files to keep
    age: 30                     # Max age in days to keep backups
  compress: true                # Compress rotated files
  buffer:
    size: 1000                  # Buffer size for async writes
  flush:
    interval:
      ms: 1000                  # Flush interval in milliseconds
  store:
    enabled: true               # Enable queryable in-memory store
    retention:
      ms: 604800000             # Store retention: 7 days (in milliseconds)
